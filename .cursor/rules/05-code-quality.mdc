---
description: Code quality standards and automated enforcement for AISTRALE
globs: backend/**/*.py, frontend/**/*.{ts,tsx}
alwaysApply: true
---

# AISTRALE Code Quality Standards

**⚠️ CRITICAL**: All code must pass quality checks before being committed. These standards ensure maintainability and consistency.

## BuildWorks-03001 Python Code Quality Tools

### Required Tools
- **Black**: Code formatting (line length: 88)
- **isort**: Import sorting
- **Flake8**: Linting (with max-line-length=88)
- **mypy**: Type checking
- **pylint**: Additional linting (optional but recommended)

### Configuration Files

**`.flake8`** (backend root):
```ini
[flake8]
max-line-length = 88
extend-ignore = E203, E266, E501, W503
exclude = 
    .git,
    __pycache__,
    .venv,
    venv,
    alembic/versions,
    *.egg-info
```

**`pyproject.toml`** (backend):
```toml
[tool.black]
line-length = 88
target-version = ['py39', 'py310', 'py311']
include = '\.pyi?$'

[tool.isort]
profile = "black"
line_length = 88

[tool.mypy]
python_version = "3.11"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
```

### Pre-commit Configuration

**`.pre-commit-config.yaml`** (project root):
```yaml
repos:
  - repo: https://github.com/psf/black
    rev: latest
    hooks:
      - id: black
        language_version: python3.11

  - repo: https://github.com/pycqa/isort
    rev: latest
    hooks:
      - id: isort

  - repo: https://github.com/pycqa/flake8
    rev: latest
    hooks:
      - id: flake8

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: latest
    hooks:
      - id: mypy
        additional_dependencies: [types-all]
```

## BuildWorks-03002 TypeScript/React Code Quality Tools

### Required Tools
- **ESLint**: Linting (already configured)
- **Prettier**: Code formatting
- **TypeScript**: Strict type checking

### Configuration Files

**`.prettierrc`** (frontend root):
```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2,
  "useTabs": false
}
```

**`tsconfig.json`** (frontend):
```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true
  }
}
```

## BuildWorks-03003 Code Formatting Standards

### Python Formatting
```python
# ✅ GOOD: Proper formatting with Black
from fastapi import FastAPI, HTTPException
from typing import Optional, List
from pydantic import BaseModel

class UserModel(BaseModel):
    id: str
    name: str
    email: str
    is_active: bool = True

@app.get("/users/", response_model=List[UserModel])
async def get_users(active_only: bool = True) -> List[UserModel]:
    """Get list of users."""
    # Implementation
    pass
```

### TypeScript Formatting
```typescript
// ✅ GOOD: Proper formatting with Prettier
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';

interface User {
  id: string;
  name: string;
  email: string;
}

export function UserList() {
  const [users, setUsers] = useState<User[]>([]);
  const navigate = useNavigate();

  useEffect(() => {
    // Fetch users
  }, []);

  return <div>{/* Component JSX */}</div>;
}
```

## BuildWorks-03004 Import Organization

### Python Imports (isort)
```python
# ✅ GOOD: Proper import order
# Standard library
import os
from typing import Optional, List

# Third-party
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from sqlmodel import Session, select

# Local
from core.config import get_settings
from models.user import User
```

### TypeScript Imports
```typescript
// ✅ GOOD: Proper import order
// React
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';

// Third-party
import axios from 'axios';

// Local
import { api } from '@/lib/api';
import { User } from '@/types';
```

## BuildWorks-03005 Type Hints & Annotations

### Python Type Hints
```python
# ✅ REQUIRED: Type hints for all functions
from typing import Optional, List, Dict, Any

async def get_user_by_id(
    db: Session, user_id: str
) -> Optional[User]:
    """Get user by ID with type hints."""
    result = db.exec(select(User).where(User.id == user_id))
    return result.first()

def process_inference(
    model: str, inputs: str, config: Dict[str, Any]
) -> Dict[str, Any]:
    """Process inference with type hints."""
    # Implementation
    pass
```

### TypeScript Types
```typescript
// ✅ REQUIRED: Type annotations for all functions
interface InferenceRequest {
  model: string;
  inputs: string;
  config?: Record<string, unknown>;
}

interface InferenceResponse {
  output: string;
  tokens: number;
  duration: number;
}

async function runInference(
  request: InferenceRequest
): Promise<InferenceResponse> {
  // Implementation
}
```

## BuildWorks-03006 Code Review Checklist

Before submitting PR, ensure:

- [ ] Code formatted with Black/isort (Python) or Prettier (TypeScript)
- [ ] All linting errors resolved
- [ ] Type checking passes (mypy/TypeScript)
- [ ] Tests pass (`pytest` or `npm test`)
- [ ] Test coverage maintained or improved
- [ ] No hardcoded secrets or credentials
- [ ] Error handling implemented
- [ ] Logging added for important operations
- [ ] Documentation updated (docstrings, README)

## BuildWorks-03007 Automated Quality Checks

### CI/CD Integration (To Be Implemented)

```yaml
# .github/workflows/quality.yml
name: Code Quality

on: [push, pull_request]

jobs:
  python-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: |
          pip install black isort flake8 mypy
          black --check .
          isort --check .
          flake8 .
          mypy .

  typescript-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: |
          cd frontend
          npm install
          npm run lint
          npm run type-check
```

## BuildWorks-03008 Code Quality Metrics

### Target Metrics
- **Test Coverage**: >80%
- **Type Coverage**: >90% (mypy/TypeScript)
- **Linting Errors**: 0
- **Code Duplication**: <5%
- **Cyclomatic Complexity**: <10 per function

### Measuring Quality
```bash
# Python coverage
pytest --cov=. --cov-report=html

# TypeScript coverage (when implemented)
npm run test:coverage

# Code complexity (optional)
pip install radon
radon cc backend/ --min B
```

---

**Next Steps**: 
- Setup pre-commit hooks: `pre-commit install`
- Run quality checks: `black . && isort . && flake8 . && mypy .`
- Review `06-testing.mdc` for testing standards
